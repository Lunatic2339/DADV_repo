<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë°ì´í„° ì‹œê°í™” | {{ user_profile.display_name }}</title>
    <style>
        body {
            background-color: #191414;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        h1, h2 { color: #1DB954; text-align: center; margin: 0; padding: 10px 0; }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #282828;
            border-bottom: 2px solid #1DB954;
            flex-shrink: 0;
        }
        .header-controls a {
            display: inline-block;
            padding: 10px 20px;
            background-color: #535353;
            color: #FFFFFF !important;
            border-radius: 500px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­: í—¤ë”ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ê³µê°„ ë¶„í•  */
        .main-content {
            display: flex;
            flex-grow: 1; 
            overflow: hidden; 
        }

        /* 1. ì™¼ìª½ ì˜ì—­: íŠ¸ë™ ëª©ë¡ ë° ë…ë¦½ ìŠ¤í¬ë¡¤ (50%) */
        .track-list-container {
            width: 50%; 
            padding: 20px;
            background-color: #121212;
            overflow-y: auto; /* ë…ë¦½ ìŠ¤í¬ë¡¤ */
            flex-shrink: 0; 
        }
        .track-list { list-style: none; padding: 0; }
        .track-list li { 
            background-color: #333; 
            padding: 10px; 
            margin-bottom: 8px; 
            border-radius: 4px; 
            font-size: 0.95em; 
        }
        .track-list .ranking { 
            font-weight: bold; 
            color: #1DB954; 
            width: 30px; 
            text-align: right; 
            margin-right: 10px;
        }

        /* 2. ì˜¤ë¥¸ìª½ ì˜ì—­: ì°¨íŠ¸ ë° ì»¨íŠ¸ë¡¤ (50%) */
        .visualization-container {
            width: 50%; 
            padding: 20px;
            background-color: #191414;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }
        .chart-container {
            width: 100%;
            max-width: 600px; 
            background-color: #282828;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .chart-controls {
            width: 100%;
            max-width: 600px;
            background-color: #282828;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .slider-label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        /* ë³¼ë¥¨ë°” ìŠ¤íƒ€ì¼ë§ */
        input[type=range] {
            width: 100%;
            margin: 10px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="page-header">
        <h1>ğŸ“Š {{ user_profile.display_name }}ë‹˜ì˜ ìŒì•… ì„ í˜¸ë„ ë¶„ì„</h1>
        <div class="header-controls">
            <a href="{% url 'dashboard' %}">
                ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <div class="main-content">
        
        <div class="track-list-container">
            <h2>ğŸ¥‡ Top Tracks (ì´ {{ total_tracks }}ê°œ)</h2>
            <ul class="track-list">
                {% for track in all_tracks %}
                <li>
                    <span class="ranking">{{ track.ranking }}.</span>
                    <div>
                        <strong>{{ track.name }}</strong>
                        <br>
                        <span style="color: #B3B3B3; font-size: 0.85em;">
                            ì•„í‹°ìŠ¤íŠ¸: {{ track.artist_name }} | ì¥ë¥´: {{ track.genre|default:'ë¯¸ì§€ì •' }} | ì¸ê¸°ë„: {{ track.popularity }}
                        </span>
                    </div>
                </li>
                {% empty %}
                <li>ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ì²­ì·¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="visualization-container">
            
            <div class="chart-controls">
                <h2>ì¸ê¸°ë„(Popularity) ë¶„í¬ ë¶„ì„</h2>
                
                <label for="rank-slider" class="slider-label">
                    ìˆœìœ„ ë²”ìœ„ (N): ìƒìœ„ <span id="rank-value">{{ max_ranking|default:50 }}</span>ê°œ íŠ¸ë™
                </label>
                
                <input type="range" id="rank-slider" min="50" 
                       max="{{ max_ranking|default:50 }}" value="50" step="1">
                <small style="color: #B3B3B3;">ìµœì†Œ 50ê°œë¶€í„° ìµœëŒ€ {{ max_ranking }}ê°œê¹Œì§€ ì¡°ì ˆ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
            </div>
            
            <div class="chart-container">
                <canvas id="popularityChart"></canvas>
            </div>
            
            <hr style="width: 80%; border-color: #333;">

            <h2 style="margin-top: 20px;">ì„ í˜¸ ì¥ë¥´ ë¶„í¬</h2>
            <div class="chart-container">
                <canvas id="genreChart"></canvas>
            </div>
            
            <h2 style="margin-top: 20px;">Top 10 ì„ í˜¸ ì•„í‹°ìŠ¤íŠ¸ (íŠ¸ë™ ìˆ˜ ê¸°ì¤€)</h2>
            <div class="chart-container">
                <canvas id="artistFocusChart" height="350"></canvas>
            </div>
            
            <div id="genre-data" style="display: none;">
                {{ top_genres | safe }}
            </div>
            <div id="popularity-initial-data" style="display: none;">
                {{ initial_popularity_data | safe }}
            </div>
            <div id="artist-focus-data" style="display: none;">
                {{ top_artists_focus | safe }}
            </div>
            
        </div>
    </div>

    <script>
        // â­â­â­ í•µì‹¬ ìˆ˜ì •: ì‘ì€ë”°ì˜´í‘œ ì¹˜í™˜ ë¡œì§ ë³µêµ¬ (ê°€ì¥ ì•ˆì •ì ì´ì—ˆë˜ ë°©ì‹) â­â­â­
        function loadAndParseData(elementId) {
            let rawData = document.getElementById(elementId).textContent.trim();
            
            // views.pyì—ì„œ json.dumps()ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, 
            // Djangoê°€ ì¶œë ¥í•œ ì‘ì€ë”°ì˜´í‘œ(')ë¥¼ JSONì´ ìš”êµ¬í•˜ëŠ” í°ë”°ì˜´í‘œ(")ë¡œ ì¹˜í™˜í•©ë‹ˆë‹¤.
            rawData = rawData.replace(/'/g, '"'); 
            
            try {
                return JSON.parse(rawData);
            } catch (e) {
                console.error("!!! JSON íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ !!!", elementId, "ì˜¤ë¥˜:", e);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜
                return [];
            }
        }
        
        // --- ë°ì´í„° ì´ˆê¸° ë¡œë“œ ---
        const initialGenreData = loadAndParseData('genre-data');
        const initialPopularityData = loadAndParseData('popularity-initial-data');
        const initialArtistData = loadAndParseData('artist-focus-data');

        // --- Chart.js ì¸ìŠ¤í„´ìŠ¤ ---
        const genreColors = ['#1DB954', '#1ED760', '#1AA64C', '#107038', '#0D572D', '#535353', '#737373', '#939393', '#B3B3B3', '#D3D3D3'];
        
        // 1. ì¥ë¥´ ì°¨íŠ¸ ì´ˆê¸°í™”
        if (initialGenreData.length > 0) {
            new Chart(document.getElementById('genreChart'), {
                type: 'doughnut',
                data: {
                    labels: initialGenreData.map(d => d.genre),
                    datasets: [{
                        data: initialGenreData.map(d => d.count),
                        backgroundColor: genreColors.slice(0, initialGenreData.length),
                        borderColor: '#191414',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: 'white' } } }
                }
            });
        }
        
        // 2. ì¸ê¸°ë„ ì°¨íŠ¸ ì´ˆê¸°í™”
        const popularityChartContext = document.getElementById('popularityChart').getContext('2d');
        const popularityChart = new Chart(popularityChartContext, {
            type: 'bar',
            data: {
                labels: initialPopularityData.map(d => d.bucket),
                datasets: [{
                    label: 'íŠ¸ë™ ìˆ˜',
                    data: initialPopularityData.map(d => d.count),
                    backgroundColor: '#1DB954',
                    borderColor: '#107038',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#333' },
                        ticks: { color: 'white' } 
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: 'white' } 
                    }
                },
                plugins: {
                    title: { display: true, text: 'ìƒìœ„ 50ê°œ íŠ¸ë™ì˜ ì¸ê¸°ë„ ë¶„í¬', color: 'white' },
                    legend: { display: false }
                }
            }
        });
        
        // 3. ì•„í‹°ìŠ¤íŠ¸ ì°¨íŠ¸ ì´ˆê¸°í™”
        if (initialArtistData.length > 0) {
            const artistFocusContext = document.getElementById('artistFocusChart').getContext('2d');
            
            new Chart(artistFocusContext, {
                type: 'bar',
                data: {
                    labels: initialArtistData.map(d => d.artist_name), 
                    datasets: [{
                        label: 'íŠ¸ë™ ê°œìˆ˜',
                        data: initialArtistData.map(d => d.count),
                        backgroundColor: 'rgba(29, 185, 84, 0.8)',
                        borderColor: 'rgba(29, 185, 84, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'íŠ¸ë™ ê°œìˆ˜', color: 'white' },
                            grid: { color: '#333' },
                            ticks: { color: 'white' }
                        },
                        y: { 
                            grid: { display: false },
                            ticks: { color: 'white' } 
                        }
                    },
                    plugins: {
                        title: { display: true, text: 'Top 10 ì„ í˜¸ ì•„í‹°ìŠ¤íŠ¸', color: 'white' },
                        legend: { display: false }
                    }
                }
            });
        }


        // --- 4. ìŠ¬ë¼ì´ë” ë° AJAX ê°±ì‹  ë¡œì§ ---
        const rankSlider = document.getElementById('rank-slider');
        const rankValueSpan = document.getElementById('rank-value');

        // AJAXë¡œ ì¸ê¸°ë„ ë°ì´í„° ê°±ì‹  í•¨ìˆ˜ (Views.pyì˜ get_popularity_data í˜¸ì¶œ)
        function updatePopularityChart(rankLimit) {
            fetch(`/visuals/popularity/?n=${rankLimit}`) 
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    const popularityData = data.popularity_data;

                    popularityChart.data.labels = popularityData.map(d => d.bucket);
                    popularityChart.data.datasets[0].data = popularityData.map(d => d.count);
                    
                    popularityChart.options.plugins.title.text = `ìƒìœ„ ${rankLimit}ê°œ íŠ¸ë™ì˜ ì¸ê¸°ë„ ë¶„í¬ (1-100)`;
                    
                    popularityChart.update();
                })
                .catch(error => console.error('Error fetching popularity data:', error));
        }

        // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        rankSlider.addEventListener('input', function() {
            const currentRank = this.value;
            rankValueSpan.textContent = currentRank;
            updatePopularityChart(currentRank); 
        });
        
        // ì´ˆê¸° ê°’ ì„¤ì •
        rankValueSpan.textContent = rankSlider.value;
    </script>
</body>
</html>